<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartStore DIEMS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-primary bg-primary text-white">
      <div class="container-fluid">
        <a class="navbar-brand text-white" href="#">
          <span class="logo-box">ðŸ“¦</span>
          <span class="ms-2">SmartStore DIEMS</span>
        </a>

        <div class="d-flex align-items-center">
          {% if session.get('username') %}
            <div class="me-3">
              {{ session.get('username') }} 
              <span class="badge bg-light text-dark">{{ session.get('role') }}</span>
            </div>

            {% if session.get('role') == 'admin' %}
              <!-- Admin Notification Bell -->
              <div class="dropdown me-3">
                <button class="btn btn-outline-light position-relative" type="button" id="notifDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  ðŸ””
                  {% set unread_count = unread_notifications if unread_notifications is defined else 0 %}
                  {% if unread_count > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                      {{ unread_count }}
                    </span>
                  {% endif %}
                </button>

                <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="notifDropdown" style="min-width: 300px; max-height: 300px; overflow-y: auto;">
                  {% set notifications_list = notifications if notifications is defined else [] %}
                  {% if notifications_list %}
                    {% for notif in notifications_list %}
                      <li class="mb-2 border-bottom pb-2">
                        <div>
                          <strong>{{ notif.staff_name }}</strong> 
                          {{ notif.action|replace('_',' ') }} 
                          <strong>{{ notif.item_name }}</strong> ({{ notif.quantity }})
                        </div>
                        <small class="text-muted">
                          {{ notif.timestamp.strftime('%Y-%m-%d %H:%M') if notif.timestamp else '' }}
                        </small>
                      </li>
                    {% endfor %}
                  {% else %}
                    <li class="text-center text-muted">No new notifications</li>
                  {% endif %}
                </ul>
              </div>
            {% endif %}

            <a class="btn btn-outline-light" href="{{ url_for('logout') }}">Logout</a>
          {% endif %}
        </div>
      </div>
    </nav>

    <div class="container my-4">
      {% block content %}{% endblock %}
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/main.js"></script>

    <script>
      function markNotificationsRead() {
        fetch("/mark_notifications_read")
          .then(() => {
            const badge = document.querySelector('#notifDropdown .badge');
            if (badge) badge.remove();
          });
      }
    </script>
  </body>

  <footer class="bg-light text-center text-lg-start mt-auto py-3">
    <div class="text-center p-3">
      Â© 2025 SmartStore DIEMS
    </div>
  </footer>
</html>
