{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1>Staff Dashboard</h1>
    <p class="text-muted">Check stock, record transactions, and request restocks</p>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card p-3">
      <div>Total Items</div>
      <h2>{{ total_items }}</h2>
      <div class="text-muted">{{ total_units }} units available</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3">
      <div>Low Stock Items</div>
      <h2>{{ low_stock_items }}</h2>
      <div class="text-muted">May need restock</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3">
      <div>Available Categories</div>
      <h2>{{ categories }}</h2>
      <div class="text-muted">Choose from existing categories</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-3">
      <div>Quick Actions</div>
      <h2>3</h2>
      <div class="text-muted">Issue, Return, Request Restock</div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card p-4 mb-4">
      <h3>Inventory Management</h3>
      <div class="row mb-3">
        <div class="col-md-7">
          <input id="searchInput2" class="form-control" placeholder="Search items...">
        </div>
        <div class="col-md-5">
          <select id="categoryFilter" class="form-select">
            <option value="all">All Categories</option>
            {% for cname in category_names %}
              <option value="{{ cname|e }}">{{ cname|e }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <table class="table" id="inventoryTable">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>Category</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="inventoryBody">
          {% for r in items %}
          <tr>
            <td>{{ r.name }}</td>
            <td>{{ r.category_name }}</td>
            <td>{{ r.quantity }}</td>
            <td>₹{{ "%.2f"|format(r.price) }}</td>
            <td>
              {% if r.quantity == 0 %}
                <span class="badge bg-danger">Out of Stock</span>
              {% elif r.quantity <= 5 %}
                <span class="badge bg-primary">Low Stock</span>
              {% else %}
                <span class="badge bg-secondary">In Stock</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-4">
      <h3>Record Transaction</h3>
      <p class="text-muted">Issue or return inventory items</p>

      <div class="mb-3">
        <label class="form-label">Select Item</label>
        <select id="txItem" class="form-select">
          <option value="">Choose an item</option>
          {% for r in items %}
            <option value="{{ r.id }}">{{ r.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Transaction Type</label>
        <select id="txType" class="form-select">
          <option value="issue">Issue Item</option>
          <option value="return">Return Item</option>
          <option value="restock_request">Request Restock</option>
        </select>
      </div>

      <div class="mb-3 row">
        <div class="col-5">
          <label class="form-label">Quantity</label>
          <input id="txQty" type="number" class="form-control" value="1">
        </div>
        <div class="col-7">
          <label class="form-label">Recipient/User Name</label>
          <input id="txRecipient" class="form-control" placeholder="Enter name">
        </div>
      </div>

      <!-- Ensure it's not a form submit button -->
      <button id="recordTx" type="button" class="btn btn-primary w-100">Record Transaction</button>
      <div id="txMsg" class="mt-2"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchInput = document.getElementById('searchInput2');
  const categoryFilter = document.getElementById('categoryFilter');
  const inventoryBody = document.getElementById('inventoryBody');
  const txItemSelect = document.getElementById('txItem');

  // server-provided idempotency key (injected from app.py as tx_key)
  const IDEMPOTENCY_KEY = "{{ tx_key|e }}";

  async function fetchAndRender() {
    const q = encodeURIComponent(searchInput.value || '');
    const category = encodeURIComponent(categoryFilter.value || 'all');
    const url = `/api/items?q=${q}&category=${category}`;
    try {
      const res = await fetch(url);
      const data = await res.json();

      // update table
      inventoryBody.innerHTML = '';
      txItemSelect.innerHTML = '<option value=\"\">Choose an item</option>';

      data.forEach(function(i){
        const tr = document.createElement('tr');
        const status = (i.quantity === 0) ? '<span class=\"badge bg-danger\">Out of Stock</span>' :
                      (i.quantity <= 5 ? '<span class=\"badge bg-primary\">Low Stock</span>' : '<span class=\"badge bg-secondary\">In Stock</span>');
        tr.innerHTML = `<td>${i.name}</td><td>${i.category||''}</td><td>${i.quantity}</td><td>₹${parseFloat(i.price).toFixed(2)}</td><td>${status}</td>`;
        inventoryBody.appendChild(tr);

        // update tx dropdown
        const opt = document.createElement('option');
        opt.value = i.id;
        opt.textContent = i.name;
        txItemSelect.appendChild(opt);
      });

    } catch (err) {
      console.error('Failed to fetch items', err);
    }
  }

  // live search + category filter
  searchInput.addEventListener('input', debounce(fetchAndRender, 250));
  categoryFilter.addEventListener('change', fetchAndRender);

  // initial render already has server-side rows, but update tx select in case
  // server-side already populated txItem; this keeps it in sync after filters.
  function debounce(fn, ms) {
    let t;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(()=>fn.apply(this,args), ms);
    };
  }

  // ====== Replace-and-attach strategy to remove any existing listeners and attach exactly one ======
  (function attachSingleHandler(){
    const recordBtn = document.getElementById('recordTx');
    if (!recordBtn) return;

    // Replace button with a clone to remove any previously attached listeners (both inline and via addEventListener)
    const cleanBtn = recordBtn.cloneNode(true);
    recordBtn.parentNode.replaceChild(cleanBtn, recordBtn);

    // now attach a single guarded listener to the clean button
    cleanBtn.addEventListener('click', async function (e) {
      // basic input validation + guard against double processing
      if (cleanBtn.dataset.processing === '1') return;
      cleanBtn.dataset.processing = '1';
      cleanBtn.disabled = true;

      const qtyRaw = document.getElementById('txQty').value;
      const payload = {
        item_id: txItemSelect.value,
        type: document.getElementById('txType').value,
        quantity: parseInt(qtyRaw, 10) || 0,
        recipient: document.getElementById('txRecipient').value,
        idempotency_key: IDEMPOTENCY_KEY
      };

      const msgBox = document.getElementById('txMsg');
      msgBox.innerHTML = '';

      try {
        const res = await fetch('/api/transaction', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await res.json();

        if (res.ok && j.ok) {
          msgBox.innerHTML = '<div class="alert alert-success">Transaction recorded</div>';
          // refresh inventory table
          fetchAndRender();
        } else {
          msgBox.innerHTML = `<div class="alert alert-danger">${j.error || 'Error'}</div>`;
        }
      } catch (err) {
        console.error('Transaction failed', err);
        msgBox.innerHTML = '<div class="alert alert-danger">Network error</div>';
      } finally {
        cleanBtn.dataset.processing = '0';
        cleanBtn.disabled = false;
      }
    });
  })();
});
</script>
{% endblock %}
